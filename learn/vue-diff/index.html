<!DOCTYPE html>
<html lang="zh-cn" itemscope itemtype="http://schema.org/WebPage">
  <head>
    
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">


<title>Vue2 -&gt; Vue3 - YJMBC Blog</title>
<meta name="description" content="vue2/3 差异">
<script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "YJMBC Blog",
    
    "url": "https:\/\/yjmbc.github.io\/"
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "",
  "url": "https:\/\/yjmbc.github.io\/"
  
  
  
  
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "item": {
          "@id": "https:\/\/yjmbc.github.io\/",
          "name": "home"
        }
    },{
        "@type": "ListItem",
        "position": 3,
        "item": {
          "@id": "https:\/\/yjmbc.github.io\/learn\/vue-diff\/",
          "name": "Vue2 vue3"
        }
    }]
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "author": {
    "name" : ""
  },
  "headline": "Vue2 -\u003e Vue3",
  "description" : "vue2\/3 差异",
  "inLanguage" : "zh-cn",
  "wordCount":  1222 ,
  "datePublished" : "2024-06-21T00:00:00",
  "dateModified" : "2024-06-21T00:00:00",
  "image" : "https:\/\/yjmbc.github.io\/",
  "keywords" : [ "vue, 2023" ],
  "mainEntityOfPage" : "https:\/\/yjmbc.github.io\/learn\/vue-diff\/",
  "publisher" : {
    "@type": "Organization",
    "name" : "https:\/\/yjmbc.github.io\/",
    "logo" : {
        "@type" : "ImageObject",
        "url" : "https:\/\/yjmbc.github.io\/",
        "height" :  60 ,
        "width" :  60
    }
  }
}
</script>

<meta property="og:title" content="Vue2 -&gt; Vue3" />
<meta property="og:description" content="vue2/3 差异">
<meta property="og:image" content="https://yjmbc.github.io/img/learn/fruit.jpg" />
<meta property="og:url" content="https://yjmbc.github.io/learn/vue-diff/" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="YJMBC Blog" />
<link rel="apple-touch-icon" sizes="180x180" href=" https://yjmbc.github.io/favicon/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://yjmbc.github.io/favicon/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://yjmbc.github.io/favicon/favicon-16x16.png">


<meta name="generator" content="Hugo 0.127.0">
<link rel="alternate" href="https://yjmbc.github.io/index.xml" type="application/rss+xml" title="YJMBC Blog">
<script src="https://yjmbc.github.io/js/dark-mode.js"></script><script src="https://yjmbc.github.io/vendor/lunr/lunr.min.js"></script><script src="https://yjmbc.github.io/vendor/lunr/lunr.stemmer.support.js"></script>
        <script src="https://yjmbc.github.io/vendor/lunr/lunr.zh.js"></script><script src="https://yjmbc.github.io/js/lunr-search.js" data-index="/search.json"></script><link rel="stylesheet" href="/style.min.css">





  




  </head>
  <body>
    
<div class="container fixed-top mw-100">
  <div class="row justify-content-center">
    <div class="col-sm-12 col-md-12 col-lg-10 col-xl-10">

      <nav class="navbar navbar-expand-lg navbar-light fixed-top p-0">
        <div class="container">

          <a class="navbar-brand fw-bold" href="https://yjmbc.github.io/">YJMBC Blog</a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
            aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>

          <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
            <ul class="navbar-nav mb-2 mb-lg-0 align-items-baseline">
              
              

              <li class="nav-item">

                
                
                
                
                

                <a class="nav-link " title="首页"
                  href="/"> 首页</a>
              </li>

              
              
              

              <li class="nav-item">

                
                
                
                
                

                <a class="nav-link " title="学习记录"
                  href="/learn/"> 学习记录</a>
              </li>

              
              
              

              <li class="nav-item">

                
                
                
                
                

                <a class="nav-link " title="实践记录"
                  href="/work/"> 实践记录</a>
              </li>

              
              
              

              <li class="nav-item">

                
                
                
                
                

                <a class="nav-link " title="阅读生活"
                  href="/readothers/"> 阅读生活</a>
              </li>

              
              
              

              <li class="nav-item">

                
                
                
                
                

                <a class="nav-link " title="分类记录"
                  href="/tags/"> 分类记录</a>
              </li>

              
              
              

              <li class="nav-item">

                
                
                
                
                

                <a class="nav-link " title="随手记"
                  href="/collections/"> 随手记</a>
              </li>

              
              

              <li class="nav-item nav-link">
                <a id="dark-mode-toggle" class="bi bi-moon-stars" role="button"></a>
              </li>

              
              <li class="nav-item search-item">
                <form id="search" class="search" role="search">
                  <label for="search-input" class="bi bi-search search-icon"></label>
                  <input type="search" id="search-input" class="search-input">
                </form>
              </li>
              
            </ul>

            
            <template id="search-heading" hidden
                data-results-none=""
                data-results-one=""
                data-results-many=""
            >
              <div class="row">
                <div class="col-lg-8 offset-lg-2 col-md-10 offset-md-1 ">
                  <h1 id="search-title" class="search-title"></h1>
                </div>
              </div>
            </template>

            <template id="search-result" hidden>
              <div class="row">
                <div class="col-lg-8 offset-lg-2 col-md-10 offset-md-1 ">
                  <article class="content post">
                    <h2><a class="summary-title-link"></a></h2>
                    <div class="post-entry"></div>
                    <div class="read-more-section">
                      <h6 class="text-muted link-underline">
                        <a class="read-more-link">
                          阅读全文
                          <i class="bi bi-arrow-right"></i>
                        </a>
                      </h6>
                    </div>
                  </article>
                </div>
              </div>
            </template>
            
          </div>
        </div>
      </nav>

    </div>
  </div>
</div>

    









<header class="header-section ">

  <div class="intro-header no-img mt-10">
    <div class="container">
      <div class="row justify-content-center">
        

          
          <div class="col-sm-12 col-md-12 col-lg-12 col-xl-12">
            

            <div class="learn-heading">
              

              

              
              <h1 class="fw-semibold display-5 lh-1 mb-3"> 
                Vue2 -&gt; Vue3
                
              </h1>
              
              

              

              
              
              
            </div>
          </div>
          
        </div>
        
        
    </div>
  </div>
</header>



    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 offset-lg-2 col-md-10 offset-md-1 ">

      <div class="card-image card-image-blog p-0">
        
        
          
            <img src="/img/learn/fruit.jpg" alt="/img/learn/fruit.jpg" class="card-img-bottom rounded img-fluid lazyload">
          
        


        
      </div>
    </div>

    <div class="col-lg-8 offset-lg-2 col-md-10 offset-md-1 pt-4">
      <article role="main" class="blog-post">
        <h1 id="api-风格">api 风格</h1>
<h2 id="选项式api--组合式api">选项式api  组合式api</h2>
<p><img src="/images/vue2-3.png" alt="image.png"></p>
<h3 id="组合式api">组合式api</h3>
<h4 id="生命周期钩子对比">生命周期钩子对比</h4>
<table>
<thead>
<tr>
<th>vue2</th>
<th>vue3</th>
</tr>
</thead>
<tbody>
<tr>
<td>beforeCreate / created</td>
<td>setup</td>
</tr>
<tr>
<td>beforeMount</td>
<td>onBeforeMount</td>
</tr>
<tr>
<td>mounted</td>
<td>onMounted</td>
</tr>
<tr>
<td>beforeUpdate</td>
<td>onBeforeUpdate</td>
</tr>
<tr>
<td>updated</td>
<td>onUpdated</td>
</tr>
<tr>
<td>beforeDestroy</td>
<td>onBeforeUnmount</td>
</tr>
<tr>
<td>destroyed</td>
<td>onUnmounted</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">setup</span>(<span style="color:#a6e22e">props</span>, <span style="color:#a6e22e">context</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Attribute (非响应式对象，等同于 $attrs)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">attrs</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 插槽 (非响应式对象，等同于 $slots)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">slots</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 触发事件 (方法，等同于 $emit)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">emit</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 暴露公共 property (函数)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">expose</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> {}
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><h1 id="响应式">响应式</h1>
<h2 id="对象和数组的动态变化">对象和数组的动态变化</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">data</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;aa&#39;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">id</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">001</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">information</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">tel</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;111xxxxx123&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">email</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;12xxxxx@xx.com&#39;</span> 
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">id</span> <span style="color:#f92672">=</span> { <span style="color:#a6e22e">number</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">001</span> };   <span style="color:#960050;background-color:#1e0010">✅</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">id</span>.<span style="color:#a6e22e">number</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">002</span>  <span style="color:#960050;background-color:#1e0010">❌</span>
</span></span></code></pre></div><h3 id="vue2-响应式">vue2 响应式</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 重新定义属性，监听起来
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">defineReactive</span>(<span style="color:#a6e22e">target</span>, <span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">value</span>){
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 再次用value嵌套调用 observe ，若为对象，则进行进一步监听，若非value非对象则直接返回
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">observe</span>(<span style="color:#a6e22e">value</span>)
</span></span><span style="display:flex;"><span>  Object.<span style="color:#a6e22e">defineProperty</span>(<span style="color:#a6e22e">target</span>, <span style="color:#a6e22e">key</span>, {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">get</span>(){
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">value</span>
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">set</span>(<span style="color:#a6e22e">newVal</span>){
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// 针对对象新增加的值进行深度监听，如 data.id = { num: 101 }, 新增加的 num 也将能够被监听到
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#75715e">// observe(newVal) 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// value 一直在闭包中，此处设置完成后，下次get能够获取最新设置的值
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">newVal</span> <span style="color:#f92672">!==</span> <span style="color:#a6e22e">value</span>){
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">value</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">newVal</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 视图更新
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">updateView</span>()
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  })
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 监听对象属性
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">observe</span>(<span style="color:#a6e22e">target</span>){
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(<span style="color:#66d9ef">typeof</span> <span style="color:#a6e22e">target</span> <span style="color:#f92672">!==</span> <span style="color:#e6db74">&#39;object&#39;</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">target</span> <span style="color:#f92672">===</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 不是数组或对象
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">target</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 如果是数组则修改该数组的原型
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span>(Array.<span style="color:#a6e22e">isArray</span>(<span style="color:#a6e22e">target</span>)){
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">target</span>.<span style="color:#a6e22e">__proto__</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">arrProperty</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 重新定义属性
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">key</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">target</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">defineReactive</span>(<span style="color:#a6e22e">target</span>, <span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">target</span>[<span style="color:#a6e22e">key</span>])
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 重新定义数组原型，加入触发更新的机制
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">oldArrayProperty</span> <span style="color:#f92672">=</span> Array.<span style="color:#a6e22e">prototype</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 创建新对象，原型指向oldArrayProperty
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">arrProperty</span> <span style="color:#f92672">=</span> Object.<span style="color:#a6e22e">create</span>(<span style="color:#a6e22e">oldArrayProperty</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">methods</span> <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;push&#39;</span>,<span style="color:#e6db74">&#39;pop&#39;</span>,<span style="color:#e6db74">&#39;shift&#39;</span>,<span style="color:#e6db74">&#39;unshift&#39;</span>,<span style="color:#e6db74">&#39;splice&#39;</span>,<span style="color:#e6db74">&#39;sort&#39;</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">methods</span>.<span style="color:#a6e22e">forEach</span>(<span style="color:#a6e22e">method</span> =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">arrProperty</span>[<span style="color:#a6e22e">method</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>(){
</span></span><span style="display:flex;"><span>    Array.<span style="color:#a6e22e">prototype</span>[<span style="color:#a6e22e">method</span>].<span style="color:#a6e22e">call</span>(<span style="color:#66d9ef">this</span>, ...<span style="color:#a6e22e">arguments</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">updateView</span>()
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">使用</span><span style="color:#960050;background-color:#1e0010">：</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span> <span style="color:#a6e22e">定义数据</span> 
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span> <span style="color:#a6e22e">observe数据</span>  
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">3</span> <span style="color:#a6e22e">对数据的属性进行修改</span>
</span></span></code></pre></div><h3 id="vue3-响应式">vue3 响应式</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#75715e">// 触发 effectFn添加行为
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">effect</span>(<span style="color:#a6e22e">effectFn</span>){
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">activeEffect</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">effectFn</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 执行effectFn，触发 get
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">effectFn</span>()
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 由于通过 set 触发副作用函数时也会导致 get 被触发，
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// 将 activeEffect 设为 null 避免重复添加副作用函数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">activeEffect</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 存储所有副作用函数的对象
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">fnList</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">WeakMap</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 收集副作用函数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">track</span>(<span style="color:#a6e22e">target</span>, <span style="color:#a6e22e">key</span>){
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">activeEffect</span>) <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 依次获取data对应的Map以及Map中key所对应的Set，有则将 activeEffect 加入，没有则新建后加入
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">dataMap</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">fnList</span>.<span style="color:#a6e22e">get</span>(<span style="color:#a6e22e">target</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">dataMap</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">dataMap</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Map</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fnList</span>.<span style="color:#a6e22e">set</span>(<span style="color:#a6e22e">target</span>, <span style="color:#a6e22e">dataMap</span>)
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">fnSet</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">dataMap</span>.<span style="color:#a6e22e">get</span>(<span style="color:#a6e22e">key</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">fnSet</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fnSet</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Set</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">dataMap</span>.<span style="color:#a6e22e">set</span>(<span style="color:#a6e22e">key</span>,<span style="color:#a6e22e">fnSet</span>)
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">fnSet</span>.<span style="color:#a6e22e">add</span>(<span style="color:#a6e22e">activeEffect</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// activeEffect.deps.push(fnSet)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 触发副作用函数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">trigger</span>(<span style="color:#a6e22e">target</span>, <span style="color:#a6e22e">key</span>){
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 获取副作用函数集并执行
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">dataMap</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">fnList</span>.<span style="color:#a6e22e">get</span>(<span style="color:#a6e22e">target</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">dataMap</span>) <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">effectFns</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">dataMap</span>.<span style="color:#a6e22e">get</span>(<span style="color:#a6e22e">key</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">effectFns</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">effectFns</span>.<span style="color:#a6e22e">forEach</span>(<span style="color:#a6e22e">effectFn</span>=&gt;<span style="color:#a6e22e">effectFn</span>())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">observe_proxy</span>(<span style="color:#a6e22e">data</span>){
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">res</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Proxy(<span style="color:#a6e22e">data</span>, {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">get</span>(<span style="color:#a6e22e">target</span>, <span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">receiver</span>){
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// 若修改的为嵌套对象，如 obj.a.b = 2，则 obj.a 触发 get，
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#75715e">// 返回嵌套代理对象，完成嵌套对象代理
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">if</span>(<span style="color:#66d9ef">typeof</span> <span style="color:#a6e22e">target</span>[<span style="color:#a6e22e">key</span>] <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;object&#39;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">target</span>[<span style="color:#a6e22e">key</span>] <span style="color:#f92672">!==</span> <span style="color:#66d9ef">null</span>){
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">observe_proxy</span>(<span style="color:#a6e22e">target</span>[<span style="color:#a6e22e">key</span>])
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// **Reflect.get()**方法与从 对象 (target[propertyKey]) 中读取属性类似，但它是通过一个函数执行来操作的
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">res</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">Reflect</span>.<span style="color:#a6e22e">get</span>(<span style="color:#a6e22e">target</span>, <span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">receiver</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// 将 effectFn 添加到 fnList 中
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#a6e22e">track</span>(<span style="color:#a6e22e">data</span>, <span style="color:#a6e22e">key</span>)  
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">res</span>
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">set</span>(<span style="color:#a6e22e">target</span>, <span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">value</span>, <span style="color:#a6e22e">receiver</span>){
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// 静态方法 Reflect.set() 工作方式就像在一个对象上设置一个属性
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">res</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">Reflect</span>.<span style="color:#a6e22e">set</span>(<span style="color:#a6e22e">target</span>, <span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">value</span>, <span style="color:#a6e22e">receiver</span>) 
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// 执行 fnList 中所有副作用函数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#a6e22e">trigger</span>(<span style="color:#a6e22e">target</span>,<span style="color:#a6e22e">key</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">res</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  })
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">res</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">newData</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ref</span>(<span style="color:#a6e22e">data</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">newData</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">observe_proxy</span>(<span style="color:#a6e22e">data</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">effectfn</span> <span style="color:#f92672">=</span> () =&gt; {<span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">xxx</span>};
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">effect</span>(<span style="color:#a6e22e">effectfn</span>)
</span></span></code></pre></div><p>weakmap  key : target  value(map) :  target.key -&gt; set(fnSet)  <br>
fnList: { <br>
[target1]: {  <br>
[target.key]: Set(fn1, fn2),   <br>
[target.key]: Set(fn4) <br>
},  <br>
[target2]: {  <br>
[target.key]: Set(fn1, fn5) <br>
}  <br>
}</p>
<h1 id="vue2-diff-算法">vue2 diff 算法</h1>
<h2 id="vue-patch">vue patch</h2>
<ul>
<li>vnode 不存在，oldVnode 存在，就删掉 oldVnode</li>
<li>vnode 存在，oldVnode 不存在，就创建 vnode</li>
<li>两个都存在的话，通过 sameVnode 函数对比是不是同一节点</li>
<li>如果是同一节点的话，通过 patchVnode 进行后续对比节点文本变化或子节点变化</li>
<li>如果不是同一节点，就把 vnode 挂载到 oldVnode 的父元素下</li>
</ul>
<h3 id="patchvnode">patchVnode</h3>
<p>1、如果vnode和oldVnode完全一致，则什么都不做处理，直接返回  <br>
2、如果oldVnode和vnode都是静态节点，且具有相同的key，并且当vnode是克隆节点或是v-once指令控制的节点时，只需要把oldVnode复制到vnode上即可     <br>
3、如果vnode不是文本节点或注释节点    <br>
1）如果vnode的children和oldVnode的children都存在，且不完全相等，则调用updateChildren更新子节点   <br>
2）如果只有vnode存在子节点，则调用addVnodes添加这些子节点</p>
<p>3）如果只有oldVnode存在子节点，则调用removeVnodes移除这些子节点    <br>
4）如果oldVnode和vnode都不存在子节点，但是oldVnode为文本节点或注释节点，则把oldVnode.elm的文本内容置为空     <br>
4、如果vnode是文本节点或注释节点，并且vnode.text和oldVnode.text不相等，则更新oldVnode的文本内容更新为vnode.text</p>
<h3 id="updatechildren">updateChildren</h3>
<p><strong>双端算法</strong>      <img src="/images/vue-diff1.png" alt="image.png">     <br>
<img src="/images/vue-diff2.png" alt="image.png"></p>
<p><strong>非理想情况</strong>   <br>
<img src="/images/vue-diff3.png" alt="image.png">   <br>
<strong>添加一个新节点</strong>    <br>
<img src="/images/vue-diff4.png" alt="image.png">   <br>
<strong>移除一个节点</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">updateChildren</span> (<span style="color:#a6e22e">parentElm</span>, <span style="color:#a6e22e">oldCh</span>, <span style="color:#a6e22e">newCh</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">oldStartIdx</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">newStartIdx</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">oldEndIdx</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">oldCh</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">oldStartVnode</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">oldCh</span>[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">oldEndVnode</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">oldCh</span>[<span style="color:#a6e22e">oldEndIdx</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">newEndIdx</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">newCh</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">newStartVnode</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">newCh</span>[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">newEndVnode</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">newCh</span>[<span style="color:#a6e22e">newEndIdx</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">oldKeyToIdx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">idxInOld</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">elmToMove</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">before</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> (<span style="color:#a6e22e">oldStartIdx</span> <span style="color:#f92672">&lt;=</span> <span style="color:#a6e22e">oldEndIdx</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">newStartIdx</span> <span style="color:#f92672">&lt;=</span> <span style="color:#a6e22e">newEndIdx</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">oldStartVnode</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>) {   <span style="color:#75715e">// 对于vnode.key的比较，会把oldVnode = null
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#a6e22e">oldStartVnode</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">oldCh</span>[<span style="color:#f92672">++</span><span style="color:#a6e22e">oldStartIdx</span>] 
</span></span><span style="display:flex;"><span>        }<span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">oldEndVnode</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">oldEndVnode</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">oldCh</span>[<span style="color:#f92672">--</span><span style="color:#a6e22e">oldEndIdx</span>]
</span></span><span style="display:flex;"><span>        }<span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">newStartVnode</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">newStartVnode</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">newCh</span>[<span style="color:#f92672">++</span><span style="color:#a6e22e">newStartIdx</span>]
</span></span><span style="display:flex;"><span>        }<span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">newEndVnode</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">newEndVnode</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">newCh</span>[<span style="color:#f92672">--</span><span style="color:#a6e22e">newEndIdx</span>]
</span></span><span style="display:flex;"><span>        }<span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">sameVnode</span>(<span style="color:#a6e22e">oldStartVnode</span>, <span style="color:#a6e22e">newStartVnode</span>)) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">patchVnode</span>(<span style="color:#a6e22e">oldStartVnode</span>, <span style="color:#a6e22e">newStartVnode</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">oldStartVnode</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">oldCh</span>[<span style="color:#f92672">++</span><span style="color:#a6e22e">oldStartIdx</span>]
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">newStartVnode</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">newCh</span>[<span style="color:#f92672">++</span><span style="color:#a6e22e">newStartIdx</span>]
</span></span><span style="display:flex;"><span>        }<span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">sameVnode</span>(<span style="color:#a6e22e">oldEndVnode</span>, <span style="color:#a6e22e">newEndVnode</span>)) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">patchVnode</span>(<span style="color:#a6e22e">oldEndVnode</span>, <span style="color:#a6e22e">newEndVnode</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">oldEndVnode</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">oldCh</span>[<span style="color:#f92672">--</span><span style="color:#a6e22e">oldEndIdx</span>]
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">newEndVnode</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">newCh</span>[<span style="color:#f92672">--</span><span style="color:#a6e22e">newEndIdx</span>]
</span></span><span style="display:flex;"><span>        }<span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">sameVnode</span>(<span style="color:#a6e22e">oldStartVnode</span>, <span style="color:#a6e22e">newEndVnode</span>)) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">patchVnode</span>(<span style="color:#a6e22e">oldStartVnode</span>, <span style="color:#a6e22e">newEndVnode</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">api</span>.<span style="color:#a6e22e">insertBefore</span>(<span style="color:#a6e22e">parentElm</span>, <span style="color:#a6e22e">oldStartVnode</span>.<span style="color:#a6e22e">el</span>, <span style="color:#a6e22e">api</span>.<span style="color:#a6e22e">nextSibling</span>(<span style="color:#a6e22e">oldEndVnode</span>.<span style="color:#a6e22e">el</span>))
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">oldStartVnode</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">oldCh</span>[<span style="color:#f92672">++</span><span style="color:#a6e22e">oldStartIdx</span>]
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">newEndVnode</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">newCh</span>[<span style="color:#f92672">--</span><span style="color:#a6e22e">newEndIdx</span>]
</span></span><span style="display:flex;"><span>        }<span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">sameVnode</span>(<span style="color:#a6e22e">oldEndVnode</span>, <span style="color:#a6e22e">newStartVnode</span>)) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">patchVnode</span>(<span style="color:#a6e22e">oldEndVnode</span>, <span style="color:#a6e22e">newStartVnode</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">api</span>.<span style="color:#a6e22e">insertBefore</span>(<span style="color:#a6e22e">parentElm</span>, <span style="color:#a6e22e">oldEndVnode</span>.<span style="color:#a6e22e">el</span>, <span style="color:#a6e22e">oldStartVnode</span>.<span style="color:#a6e22e">el</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">oldEndVnode</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">oldCh</span>[<span style="color:#f92672">--</span><span style="color:#a6e22e">oldEndIdx</span>]
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">newStartVnode</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">newCh</span>[<span style="color:#f92672">++</span><span style="color:#a6e22e">newStartIdx</span>]
</span></span><span style="display:flex;"><span>        }<span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>           <span style="color:#75715e">// 使用key时的比较
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">oldKeyToIdx</span> <span style="color:#f92672">===</span> <span style="color:#66d9ef">undefined</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">oldKeyToIdx</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">createKeyToOldIdx</span>(<span style="color:#a6e22e">oldCh</span>, <span style="color:#a6e22e">oldStartIdx</span>, <span style="color:#a6e22e">oldEndIdx</span>) <span style="color:#75715e">// 有key生成index表
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">idxInOld</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">oldKeyToIdx</span>[<span style="color:#a6e22e">newStartVnode</span>.<span style="color:#a6e22e">key</span>]
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">idxInOld</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">api</span>.<span style="color:#a6e22e">insertBefore</span>(<span style="color:#a6e22e">parentElm</span>, <span style="color:#a6e22e">createEle</span>(<span style="color:#a6e22e">newStartVnode</span>).<span style="color:#a6e22e">el</span>, <span style="color:#a6e22e">oldStartVnode</span>.<span style="color:#a6e22e">el</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">newStartVnode</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">newCh</span>[<span style="color:#f92672">++</span><span style="color:#a6e22e">newStartIdx</span>]
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">elmToMove</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">oldCh</span>[<span style="color:#a6e22e">idxInOld</span>]
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">elmToMove</span>.<span style="color:#a6e22e">sel</span> <span style="color:#f92672">!==</span> <span style="color:#a6e22e">newStartVnode</span>.<span style="color:#a6e22e">sel</span>) {
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">api</span>.<span style="color:#a6e22e">insertBefore</span>(<span style="color:#a6e22e">parentElm</span>, <span style="color:#a6e22e">createEle</span>(<span style="color:#a6e22e">newStartVnode</span>).<span style="color:#a6e22e">el</span>, <span style="color:#a6e22e">oldStartVnode</span>.<span style="color:#a6e22e">el</span>)
</span></span><span style="display:flex;"><span>                }<span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">patchVnode</span>(<span style="color:#a6e22e">elmToMove</span>, <span style="color:#a6e22e">newStartVnode</span>)
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">oldCh</span>[<span style="color:#a6e22e">idxInOld</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">api</span>.<span style="color:#a6e22e">insertBefore</span>(<span style="color:#a6e22e">parentElm</span>, <span style="color:#a6e22e">elmToMove</span>.<span style="color:#a6e22e">el</span>, <span style="color:#a6e22e">oldStartVnode</span>.<span style="color:#a6e22e">el</span>)
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">newStartVnode</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">newCh</span>[<span style="color:#f92672">++</span><span style="color:#a6e22e">newStartIdx</span>]
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">oldStartIdx</span> <span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">oldEndIdx</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">before</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">newCh</span>[<span style="color:#a6e22e">newEndIdx</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">?</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">:</span> <span style="color:#a6e22e">newCh</span>[<span style="color:#a6e22e">newEndIdx</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>].<span style="color:#a6e22e">el</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">addVnodes</span>(<span style="color:#a6e22e">parentElm</span>, <span style="color:#a6e22e">before</span>, <span style="color:#a6e22e">newCh</span>, <span style="color:#a6e22e">newStartIdx</span>, <span style="color:#a6e22e">newEndIdx</span>)
</span></span><span style="display:flex;"><span>    }<span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">newStartIdx</span> <span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">newEndIdx</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">removeVnodes</span>(<span style="color:#a6e22e">parentElm</span>, <span style="color:#a6e22e">oldCh</span>, <span style="color:#a6e22e">oldStartIdx</span>, <span style="color:#a6e22e">oldEndIdx</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h1 id="vue3-diff算法">vue3 diff算法</h1>
<ul>
<li>头和头比</li>
<li>尾和尾比</li>
<li>基于最长递增子序列进行移动/添加/删除</li>
</ul>
<p><img src="/images/vue-diff5.png" alt="image.png"></p>
<p><img src="/images/vue-diff6.png" alt="image.png">   <br>
1 当前的索引为最长递增子序列中的值，也就是i === seq[j]，这说说明该节点不需要移动</p>
<p><strong>最长增长子序列</strong> <br>
动态 <br>
贪心+二分  <br>
图解： <a href="https://leetcode.cn/problems/longest-increasing-subsequence/solution/dong-tai-gui-hua-er-fen-cha-zhao-tan-xin-suan-fa-p/">https://leetcode.cn/problems/longest-increasing-subsequence/solution/dong-tai-gui-hua-er-fen-cha-zhao-tan-xin-suan-fa-p/</a></p>
<ul>
<li>初始化， 里面内容无所谓 和 原本的数组长度相同就行 用来存放索引</li>
<li>默认追加，标记当前一项（也就是最后一项）前一个对应的索引</li>
<li>假设有：[2,3,1,5,6,8,7,9,4] 为最新序列 -&gt; 按照上述结果得出的结论为：[ 2, 1, 8, 4, 6, 7 ]</li>
<li>替换并记录前驱节点，核心点：记录 “要替换的值的 前一个的索引”</li>
<li>以序列中最后一个值对应的索引向前追溯 最后一项肯定是正确的</li>
</ul>
<p><img src="/images/vue-diff7.png" alt="image.png"></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">getSequence</span>(<span style="color:#a6e22e">arr</span>) { <span style="color:#75715e">// 最终的结果是索引
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">len</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">arr</span>.<span style="color:#a6e22e">length</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> [<span style="color:#ae81ff">0</span>]; <span style="color:#75715e">// 保存最长递增子序列的索引  以默认第0个位基准
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 【3.1】初始化， 里面内容无所谓 和 原本的数组长度相同就行 用来存放索引 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">p</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Array(<span style="color:#a6e22e">len</span>).<span style="color:#a6e22e">fill</span>(<span style="color:#ae81ff">0</span>); 
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">resultLastIndex</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">len</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 【1】、找到索引先放进去
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">arrI</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">arr</span>[<span style="color:#a6e22e">i</span>]; <span style="color:#75715e">// 获取数组中的每一项，
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// 0 在我们diff算法中代表新增 所以要忽略
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">arrI</span> <span style="color:#f92672">!==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">resultLastIndex</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">result</span>[<span style="color:#a6e22e">result</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>];  <span style="color:#75715e">// 找到序列中的最后一项
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">arr</span>[<span style="color:#a6e22e">resultLastIndex</span>] <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">arrI</span>) {  <span style="color:#75715e">// 取出序列中的最后一项对应的值 与当前项的值相比较
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#75715e">// 【3.2】默认追加，标记当前一项（也就是最后一项）前一个对应的索引  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#75715e">// p[i]就是当前一项
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#a6e22e">p</span>[<span style="color:#a6e22e">i</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">resultLastIndex</span>; 
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">result</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">i</span>); <span style="color:#75715e">// 记录索引
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 第一步结束结果：console.log(getSequence([1,2,3,4,5,6,7,0]))  // [0,1,2,3,4,5,6]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 【2】、二分查找 在结果集中找到比当前值大的 用当前值的索引将其替换掉
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#75715e">// result是递增序列 采用二分查找是最快的
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">start</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">end</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">result</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>; <span style="color:#75715e">// 二分查找 前后索引
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">while</span> (<span style="color:#a6e22e">start</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">end</span>) { <span style="color:#75715e">// 最终 start = end 就停止了
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">middle</span> <span style="color:#f92672">=</span> ((<span style="color:#a6e22e">start</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">end</span>) <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>) <span style="color:#f92672">|</span> <span style="color:#ae81ff">0</span>; <span style="color:#75715e">// 向下取整
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#75715e">// 拿result中间值 和 当前项 比较
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">arr</span>[<span style="color:#a6e22e">result</span>[<span style="color:#a6e22e">middle</span>]] <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">arrI</span>) { <span style="color:#75715e">// 找比arrI大的值 或者等于arrI
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    <span style="color:#a6e22e">start</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">middle</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>                } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">end</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">middle</span>;  
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">arrI</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">arr</span>[<span style="color:#a6e22e">result</span>[<span style="color:#a6e22e">end</span>]]) { <span style="color:#75715e">// 当前项小于中间值就替换掉大的那一项
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">end</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) { <span style="color:#75715e">// end &gt; 0 才需要替换 p[i]就是当前一项
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    <span style="color:#a6e22e">p</span>[<span style="color:#a6e22e">i</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">result</span>[<span style="color:#a6e22e">end</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>]; <span style="color:#75715e">// 【3.3】替换并记录前驱节点，核心点：记录 “要替换的值的 前一个的索引”
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">result</span>[<span style="color:#a6e22e">end</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">i</span>; 
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 第二步结束结果：console.log(getSequence([2,3,1,5,6,8,7,9,4] ))  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#75715e">// 找到的索引：[ 2, 1, 8, 4, 6, 7 ] 找到的值：[1,3,4,6,7,9]  个数： 6
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#75715e">// 个数是对的但是 找到的值是不对的应该是 [2,3,5,6,7,9]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 3.3得到的结果 [0,0,undefined,1,3,4,4,6,1]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// 【3.4】以序列中最后一个值对应的索引向前追溯  最后一项肯定是正确的
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">//找到的索引  [7,6,4,3,1,0]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// 找到的值 [9,7,6,5,3,2] 和要找到的刚好相反
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">result</span>.<span style="color:#a6e22e">length</span> <span style="color:#75715e">// 总长度
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">last</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">result</span>[<span style="color:#a6e22e">i</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>] <span style="color:#75715e">// 找到了最后一项
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">while</span> (<span style="color:#a6e22e">i</span><span style="color:#f92672">--</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) { <span style="color:#75715e">// 倒序追溯 根据前驱节点一个个向前查找
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">result</span>[<span style="color:#a6e22e">i</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">last</span> <span style="color:#75715e">// 最后一项肯定是正确的
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">last</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">p</span>[<span style="color:#a6e22e">last</span>] <span style="color:#75715e">// 重新赋值
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// console.log(getSequence([2,3,1,5,6,8,7,9,4] ))  [0,1,3,4,6,7]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">result</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h1 id="vue2模版编译">vue2模版编译</h1>
<ol>
<li>_s 是 toString，序列化成文本</li>
<li>_v 是 createTextVNode，创建一个 text virtual DOM 节点</li>
<li>_c 是 createElement，创建一个 element virtual DOM 节点</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">div</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">header</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">h1</span><span style="color:#f92672">&gt;</span><span style="color:#a6e22e">I</span><span style="color:#e6db74">&#39;m a template!&lt;/h1&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &lt;/header&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &lt;p v-if=&#34;message&#34;&gt;{{ message }}&lt;/p&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &lt;p v-else&gt;No message.&lt;/p&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &lt;/div&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">// 动态
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">function anonymous(
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">) {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  with(this){return _c(&#39;</span><span style="color:#a6e22e">div</span><span style="color:#e6db74">&#39;,[_m(0),(message)?_c(&#39;</span><span style="color:#a6e22e">p</span><span style="color:#e6db74">&#39;,[_v(_s(message))]):_c(&#39;</span><span style="color:#a6e22e">p</span><span style="color:#e6db74">&#39;,[_v(&#34;No message.&#34;)])])}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">// 静态
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">_m(0): function anonymous(
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">) {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  with(this){return _c(&#39;</span><span style="color:#a6e22e">header</span><span style="color:#e6db74">&#39;,[_c(&#39;</span><span style="color:#a6e22e">h1</span><span style="color:#e6db74">&#39;,[_v(&#34;I&#39;</span><span style="color:#a6e22e">m</span> <span style="color:#a6e22e">a</span> <span style="color:#a6e22e">template</span><span style="color:#f92672">!</span><span style="color:#960050;background-color:#1e0010">&#34;</span>)])])}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>在 Vue2 里每当触发更新的时候，不管元素是否参与更新，每次都会全部重新创建</p>
<h1 id="vue3渲染">vue3渲染</h1>
<p>引用尤雨溪： 为了实现这一点，编译器和运行时需要协同工作：编译器分析模板并生成带有优化提示的代码，而运行时尽可能获取提示并采用快速路径。这里有三个主要的优化：</p>
<ul>
<li>首先，在DOM树级别。我们注意到，在没有动态改变节点结构的模板指令（例如v-if和v-for）的情况下，节点结构保持完全静态。如果我们将一个模板分成由这些结构指令分隔的嵌套“块”，则每个块中的节点结构将再次完全静态。当我们更新块中的节点时，我们不再需要递归遍历DOM树 - 该块内的动态绑定可以在一个平面数组中跟踪。这种优化通过将需要执行的树遍历量减少一个数量级来规避虚拟DOM的大部分开销。</li>
<li>其次，编译器积极地检测模板中的静态节点、子树甚至数据对象，并在生成的代码中将它们提升到渲染函数之外。这样可以避免在每次渲染时重新创建这些对象，从而大大提高内存使用率并减少垃圾回收的频率。</li>
<li>第三，在元素级别。编译器还根据需要执行的更新类型，为每个具有动态绑定的元素生成一个优化标志。例如，具有动态类绑定和许多静态属性的元素将收到一个标志，提示只需要进行类检查。运行时将获取这些提示并采用专用的快速路径。</li>
<li>综合起来，这些技术大大改进了我们的渲染更新基准，Vue 3有时占用的CPU时间不到Vue 2的十分之一。</li>
</ul>
<h2 id="静态提升">静态提升</h2>
<p>静态节点的创建被拿到了渲染函数外面</p>
<p><a href="https://vue-next-template-explorer.netlify.app/#eyJzcmMiOiJcbjxkaXY+XG4gICAgICAgIDxoZWFkZXI+XG4gICAgICAgICAgPGgxPkknbSBhIHRlbXBsYXRlITwvaDE+XG4gICAgICAgICAgPHAgY2xhc3M9XCJoZWxsb1wiPmhlbGxvPC9wPlxuXG4gICAgICAgICAgPHA+aGVsbG88L3A+XG4gICAgICAgICAgPHA+aGVsbG88L3A+XG4gICAgICAgICAgPHA+aGVsbG88L3A+XG4gICAgICAgICAgPHA+aGVsbG88L3A+XG4gICAgICAgICAgPHA+aGVsbG88L3A+XG4gICAgICAgICAgPHA+aGVsbG88L3A+XG4gICAgICAgICAgPHA+aGVsbG88L3A+XG4gICAgICAgICAgPHA+aGVsbG88L3A+XG4gICAgICAgICAgPHAgY2xhc3M9XCJoZWxsb1wiPmhlbGxvPC9wPlxuICAgICAgICAgIDxwIGNsYXNzPVwiaGVsbG9cIj5oZWxsbzwvcD5cbiAgICAgICAgICA8cCBjbGFzcz1cImhlbGxvXCI+aGVsbG88L3A+XG4gICAgICAgICAgPHAgY2xhc3M9XCJoZWxsb1wiPmhlbGxvPC9wPlxuICAgICAgICAgIDxwIGNsYXNzPVwiaGVsbG9cIj5oZWxsbzwvcD5cblxuICAgICAgICA8L2hlYWRlcj5cbiAgICAgICAgPGJ1dHRvbiBvbmNsaWNrPVwiaGFuZGxlQ2xpY2tcIj5hbm5pdTwvYnV0dG9uPlxuICAgICAgICA8cCB2LWlmPVwibWVzc2FnZVwiPnt7IG1lc3NhZ2UgfX08L3A+XG4gICAgICAgIDxwIHYtZWxzZT5ObyBtZXNzYWdlLjwvcD5cblxuICAgICAgICAgIDxwIGNsYXNzPVwiaGVsbG9cIj5oZWxsbzwvcD5cbiAgICAgICAgICA8cCBjbGFzcz1cImhlbGxvXCI+aGVsbG88L3A+XG4gICAgICAgICAgPHAgY2xhc3M9XCJoZWxsb1wiPmhlbGxvPC9wPlxuICAgICAgICAgIDxwIGNsYXNzPVwiaGVsbG9cIj5oZWxsbzwvcD5cbiAgICAgICAgICA8cCBjbGFzcz1cImhlbGxvXCI+aGVsbG88L3A+XG4gICAgICAgICAgPHAgY2xhc3M9XCJoZWxsb1wiPmhlbGxvPC9wPlxuICAgICAgPC9kaXY+Iiwic3NyIjpmYWxzZSwib3B0aW9ucyI6eyJob2lzdFN0YXRpYyI6dHJ1ZX19">https://vue-next-template-explorer.netlify.app/#eyJzcmMiOiJcbjxkaXY+XG4gICAgICAgIDxoZWFkZXI+XG4gICAgICAgICAgPGgxPkknbSBhIHRlbXBsYXRlITwvaDE+XG4gICAgICAgICAgPHAgY2xhc3M9XCJoZWxsb1wiPmhlbGxvPC9wPlxuXG4gICAgICAgICAgPHA+aGVsbG88L3A+XG4gICAgICAgICAgPHA+aGVsbG88L3A+XG4gICAgICAgICAgPHA+aGVsbG88L3A+XG4gICAgICAgICAgPHA+aGVsbG88L3A+XG4gICAgICAgICAgPHA+aGVsbG88L3A+XG4gICAgICAgICAgPHA+aGVsbG88L3A+XG4gICAgICAgICAgPHA+aGVsbG88L3A+XG4gICAgICAgICAgPHA+aGVsbG88L3A+XG4gICAgICAgICAgPHAgY2xhc3M9XCJoZWxsb1wiPmhlbGxvPC9wPlxuICAgICAgICAgIDxwIGNsYXNzPVwiaGVsbG9cIj5oZWxsbzwvcD5cbiAgICAgICAgICA8cCBjbGFzcz1cImhlbGxvXCI+aGVsbG88L3A+XG4gICAgICAgICAgPHAgY2xhc3M9XCJoZWxsb1wiPmhlbGxvPC9wPlxuICAgICAgICAgIDxwIGNsYXNzPVwiaGVsbG9cIj5oZWxsbzwvcD5cblxuICAgICAgICA8L2hlYWRlcj5cbiAgICAgICAgPGJ1dHRvbiBvbmNsaWNrPVwiaGFuZGxlQ2xpY2tcIj5hbm5pdTwvYnV0dG9uPlxuICAgICAgICA8cCB2LWlmPVwibWVzc2FnZVwiPnt7IG1lc3NhZ2UgfX08L3A+XG4gICAgICAgIDxwIHYtZWxzZT5ObyBtZXNzYWdlLjwvcD5cblxuICAgICAgICAgIDxwIGNsYXNzPVwiaGVsbG9cIj5oZWxsbzwvcD5cbiAgICAgICAgICA8cCBjbGFzcz1cImhlbGxvXCI+aGVsbG88L3A+XG4gICAgICAgICAgPHAgY2xhc3M9XCJoZWxsb1wiPmhlbGxvPC9wPlxuICAgICAgICAgIDxwIGNsYXNzPVwiaGVsbG9cIj5oZWxsbzwvcD5cbiAgICAgICAgICA8cCBjbGFzcz1cImhlbGxvXCI+aGVsbG88L3A+XG4gICAgICAgICAgPHAgY2xhc3M9XCJoZWxsb1wiPmhlbGxvPC9wPlxuICAgICAgPC9kaXY+Iiwic3NyIjpmYWxzZSwib3B0aW9ucyI6eyJob2lzdFN0YXRpYyI6dHJ1ZX19</a></p>
<h2 id="更新类型标记">更新类型标记</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">enum</span> <span style="color:#a6e22e">PatchFlags</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">TEXT</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> ,  <span style="color:#75715e">// 动态文本节点
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">CLASS</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">1</span>,  <span style="color:#75715e">// 2   动态class
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">STYLE</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">2</span>,  <span style="color:#75715e">// 4   动态style
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">PROPS</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">3</span>,  <span style="color:#75715e">// 8   除去class/style以外的动态属性
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">FULL_PROPS</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">4</span>,       <span style="color:#75715e">// 16  有动态key属性的节点，当key改变时，需进行完整的diff比较
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">HYDRATE_EVENTS</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">5</span>,   <span style="color:#75715e">// 32  有监听事件的节点
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">STABLE_FRAGMENT</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">6</span>,  <span style="color:#75715e">// 64  一个不会改变子节点顺序的fragment (一个组件内多个根元素就会用fragment包裹)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">KEYED_FRAGMENT</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">7</span>,   <span style="color:#75715e">// 128 带有key属性的fragment或部分子节点有key
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">UNKEYEN_FRAGMENT</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">8</span>, <span style="color:#75715e">// 256  子节点没有key的fragment
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">NEED_PATCH</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">9</span>,       <span style="color:#75715e">// 512  一个节点只会进行非props比较
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">DYNAMIC_SLOTS</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">10</span>,   <span style="color:#75715e">// 1024   动态slot
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">HOISTED</span> <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,  <span style="color:#75715e">// 静态节点 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">BAIL</span> <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>      <span style="color:#75715e">// 表示 Diff 过程中不需要优化
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><h2 id="树结构打平">树结构打平</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">div</span><span style="color:#f92672">&gt;</span> <span style="color:#75715e">&lt;!--</span> <span style="color:#a6e22e">root</span> <span style="color:#a6e22e">block</span> <span style="color:#f92672">--&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">div</span><span style="color:#f92672">&gt;</span>...<span style="color:#f92672">&lt;</span><span style="color:#960050;background-color:#1e0010">/div&gt;         &lt;!-- 不会追踪 --&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">div</span> <span style="color:#f92672">:</span><span style="color:#a6e22e">id</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;id&#34;</span><span style="color:#f92672">&gt;&lt;</span><span style="color:#960050;background-color:#1e0010">/div&gt;   &lt;!-- 要追踪 --&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">div</span><span style="color:#f92672">&gt;</span>                  <span style="color:#75715e">&lt;!--</span> <span style="color:#a6e22e">不会追踪</span> <span style="color:#f92672">--&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">div</span><span style="color:#f92672">&gt;</span>{{ <span style="color:#a6e22e">bar</span> }}<span style="color:#f92672">&lt;</span><span style="color:#960050;background-color:#1e0010">/div&gt; &lt;!-- 要追踪 --&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;</span><span style="color:#960050;background-color:#1e0010">/div&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#960050;background-color:#1e0010">/div&gt;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">div</span> (<span style="color:#a6e22e">block</span> <span style="color:#a6e22e">root</span>)
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span> <span style="color:#a6e22e">div</span> <span style="color:#a6e22e">带有</span> <span style="color:#f92672">:</span><span style="color:#a6e22e">id</span> <span style="color:#a6e22e">绑定</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span> <span style="color:#a6e22e">div</span> <span style="color:#a6e22e">带有</span> {{ <span style="color:#a6e22e">bar</span> }} <span style="color:#a6e22e">绑定</span>
</span></span></code></pre></div>
      </article>
    </div>
  </div>

  
  <div class="row">
    <div class="col-lg-8 offset-lg-2 col-md-10 offset-md-1">
      <hr class="m-0"/>
    </div>
    <div class="col-lg-8 offset-lg-2 col-md-10 offset-md-1 pt-2">
      
      <div class="blog-tags">
        
        <a href="https://yjmbc.github.io/tags/vue/">vue</a>
        
        <a href="https://yjmbc.github.io/tags/2023/">2023</a>
        
      </div>
      
    </div>

    <div class="col-lg-8 offset-lg-2 col-md-10 offset-md-1 pt-4">
      
    </div>

    

    <div class="col-lg-8 offset-lg-2 col-md-12 offset-md-1 pt-4">
      
      <ul class="list-group list-group-horizontal" style="flex-direction: row">
        
        <li class="list-group-item b-0 p-0">

          <a type="button" class="btn btn-dark" role="button" href="https://yjmbc.github.io/learn/vue3-react/"
            data-toggle="tooltip" data-placement="top" title="Vue3 React">&larr;
            前一篇</a>
        </li>
        


        
      </ul>
      
    </div>

    <div class="col-lg-8 offset-lg-2 col-md-10 offset-md-1 pt-4">
    </div>
  </div>
  
</div>

<div class="">
  
  
  
  
  

  
  <div class="container">
    <div class="row">
      <div class="col-lg-12 col-md-12 mt-3">
        <h3>阅读全文</h3>
        <hr />
      </div>

      
      

      
<div class="col-xl-4 col-lg-4 col-md-6 col-sm-6  mb-4">
    <a href="https://yjmbc.github.io/collections/debugger/">
        <div class="card h-100 single-post-card shadow-effect bg-faded-light border">
            <div class="card-body">
                <h3 class="fw-bold post-title">阻止用户debugger</h3>
                

                <p class="post-meta">
                    <span class="post-meta text-muted">
  
  

  2024-07-15

  

  
  &nbsp;|&nbsp; <i class="bi bi-clock"></i>&nbsp;1&nbsp;分钟
  

  
  &nbsp;|&nbsp;<i class="bi bi-book"></i>&nbsp;12&nbsp;个字
  

  
</span>

                </p>
                

                <div class="post-entry">
                    
                    如何阻止用户打开控制台

                    
                </div>

                <div class="read-more-section">
                    
                    <h6 class="text-muted link-underline">阅读全文 <i class="bi bi-arrow-right"></i></h6>
                </div>
            </div>

            
            <img src="/img/collections/cat1_hu6129f33885e3157ac7a271237159852d_371859_500x0_resize_q75_box.jpg" alt="/img/collections/cat1.jpg"
                class="card-img-bottom img-fluid lazyload">
            

            
        </div>
    </a>
</div>


      

      
<div class="col-xl-4 col-lg-4 col-md-6 col-sm-6  mb-4">
    <a href="https://yjmbc.github.io/work/drag/">
        <div class="card h-100 single-post-card shadow-effect bg-faded-light border">
            <div class="card-body">
                <h3 class="fw-bold post-title">拖拽实现记录</h3>
                

                <p class="post-meta">
                    <span class="post-meta text-muted">
  
  

  2024-07-12

  

  
  &nbsp;|&nbsp; <i class="bi bi-clock"></i>&nbsp;4&nbsp;分钟
  

  
  &nbsp;|&nbsp;<i class="bi bi-book"></i>&nbsp;655&nbsp;个字
  

  
</span>

                </p>
                

                <div class="post-entry">
                    
                    拖拽功能实现记录

                    
                </div>

                <div class="read-more-section">
                    
                    <h6 class="text-muted link-underline">阅读全文 <i class="bi bi-arrow-right"></i></h6>
                </div>
            </div>

            
            <img src="/img/work/cartoon_hu898a29aec834a4e9ef0febf28067c038_17495_500x0_resize_q75_box.jpg" alt="/img/work/cartoon.jpg"
                class="card-img-bottom img-fluid lazyload">
            

            
        </div>
    </a>
</div>


      

      
<div class="col-xl-4 col-lg-4 col-md-6 col-sm-6  mb-4">
    <a href="https://yjmbc.github.io/learn/vue3-react/">
        <div class="card h-100 single-post-card shadow-effect bg-faded-light border">
            <div class="card-body">
                <h3 class="fw-bold post-title">Vue3 React</h3>
                

                <p class="post-meta">
                    <span class="post-meta text-muted">
  
  

  2024-06-21

  

  
  &nbsp;|&nbsp; <i class="bi bi-clock"></i>&nbsp;13&nbsp;分钟
  

  
  &nbsp;|&nbsp;<i class="bi bi-book"></i>&nbsp;2628&nbsp;个字
  

  
</span>

                </p>
                

                <div class="post-entry">
                    
                    vue3 和 react

                    
                </div>

                <div class="read-more-section">
                    
                    <h6 class="text-muted link-underline">阅读全文 <i class="bi bi-arrow-right"></i></h6>
                </div>
            </div>

            
            <img src="/img/learn/sea_hu780799d42b2197c7b11de0593c718c79_246613_500x0_resize_q75_box.jpg" alt="/img/learn/sea.jpg"
                class="card-img-bottom img-fluid lazyload">
            

            
        </div>
    </a>
</div>


      
    </div>
  </div>
  
  

  

</div>

    


<footer>

  <div class="container">
    <div class="row">
      <div class="col-md-12">
        <ul
          class="list-inline list-group list-group-horizontal text-center footer-links d-flex justify-content-center flex-row">

          
          
          <li>
            <a href="" title="RSS">
              <span class="mx-2">
                <i class="bi bi-rss"></i>
              </span>
            </a>
          </li>
          
        </ul>
      </div>
    </div>

    <div class="row">
      <div class="col-md-12">
        <p class="credits copyright text-muted">
          

          &nbsp;&bull;&nbsp;&copy;
          
          2024
          

          
          &nbsp;&bull;&nbsp;
          <a href="https://yjmbc.github.io/">YJMBC Blog</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          Powered by <a href="https://gohugo.io">Hugo</a> & <a href="https://github.com/binokochumolvarghese/lightbi-hugo">Lightbi.</a>&nbsp; Made with ❤ by <a href="https://binovarghese.com">Bino</a>
          
        </p>
      </div>
    </div>
  </div>
</footer><script src="https://yjmbc.github.io/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="https://yjmbc.github.io/js/highlight.min.js"></script>
<script> hljs.initHighlightingOnLoad(); </script>
<script> $(document).ready(function () { $("pre.chroma").css("padding", "0"); }); </script>

    
  </body>
</html>

